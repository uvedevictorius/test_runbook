# **Runbook - Cambio de autorizadores de una entidad**


### **Introducción**
Este Runbook proporciona instrucciones paso a paso para llevar a cabo una tarea operativa específica dentro del Servicio de Plataforma de Ingeniería. El objetivo es cambiar los autorizadores de una entidad de Poseidón.


### **Información del Documento**
- **Título del Runbook:** Cambio de autorizadores de una entidad  
- **Versión:** 1.1  
- **Fecha de Creación:** 01/04/2025  
- **Fecha de Última Modificación:** 10/04/2025  
- **Autor:** Víctor Márquez Gómez  
- **Revisor:** Samuel Carretero Jara  
- **Aprobador:** Rubén Barrero Ortega 


### **1. Información General**
- **Descripción de la Tarea:** Cambiar el autorizador de una entidad dentro de Poseidón.  
- **Servicio/Sistema Afectado:** MongoDB (AWS) y portal Plataforma Ingeniería.  
- **Duración Estimada:** 20 minutos aproximadamente.  
- **Ventana de Mantenimiento:** N/A.  
- **Riesgos:** Autorizar una tarea conlleva un coste dentro del proveedor Cloud.  
- **Requisitos Previos:** Conocer el autorizador y la entidad que se quiere modificar, tener permisos para modificar la base de datos y autorización por parte de Pluto para cambiar la lista de autorizadores. 


### **2. Procedimiento Detallado**
**Paso 1:** Conectarse a la base de datos de Poseidón MongoDB (Leer pasos a continuación).
**Paso 1.1:** Acceder a la cuenta aws-pro-poseidon-mapfretech (847912841198) de AWS de Poseidón haciendo click en owner. (Accounts | AWS access portal).


**Paso 1.2:** Acceder al servicio Cloud9 a través de AWS.


**Paso 1.3:** Establecer conexión con MongoDB a través del entorno “fparisowner” seleccionando el apartado de “Shared with me” y luego “Open in Cloud9” dentro del entorno.


**Paso 1.4:** Utilizar comando con contraseña en una nueva terminal para establecer conexión con la base de datos de Poseidón.  
`($ mongo --ssl --host psdn-source-psdn-metadata.cluster-ctrly2qeqwpv.eu-west-1.docdb.amazonaws.com:27017 --sslCAFile global-bundle.pem --username admin1 --password XXXXXX) y, escribir “use poseidon”)`

**Paso 2:** Buscar la lista de autorizadores de la entidad en la base de datos de Poseidón utilizando el siguiente comando y buscando la colección "entity_authorizers". `"entity_authorizers"`:

``db.entity.find({"entity_name":"XXX"}).pretty()``

Si ya aparece el autorizador deseado en la lista, comunicar a L1

**Paso 2.1:** Crear backup de la base de datos con el siguiente comando: (Se necesita contraseña) 

``mongoexport --ssl --host 'psdn-source-psdn-metadata.cluster-ctrly2qeqwpv.eu-west-1.docdb.amazonaws.com:27017' --sslCAFile global-bundle.pem --username 'admin1' --password 'XXXX' --db 'poseidon' --ssl --collection='XXXX' --out=XXXX_YearMonthDayHourMinutes.json``

**Paso 3**: Crear backup de la base de datos con el siguiente comando: (Se necesita contraseña) 

 `mongoexport --ssl --host 'psdn-source-psdn-metadata.cluster-ctrly2qeqwpv.eu-west-1.docdb.amazonaws.com:27017' --sslCAFile global-bundle.pem --username 'admin1'---password 'XXXX' --db 'poseidon' --ssl --collection='XXXX' --out=XXXX_YearMonthDayHourMinutes.json`
 
**Paso 4**: Editar la lista de autorizadores ("entity_authorizers") utilizando el siguiente comando: 

`db.entity.updateOne({"entity_name": “XXX"}, {$set:{"entity_authorizers" : [{"authorizer_email" : "XXX", "authorizer_display_name" : "XXX", "authorizer_upn" : "XXX"}, {"authorizer_email" : "XXX, "authorizer_display_name" : "XXX", "authorizer_upn" : "XXX"}]}})` 


### **3. Verificación y Validación**

**Criterios de Éxito**: Mensaje de confirmación en Mondo DB. 

`{ "acknowledged" : true, "matchedCount" : 1, "modifiedCount" : 1 }` 

## 4. Manejo de Excepciones y Rollback

**Posibles Errores y Formas de Solucionarlo:** Errores humanos (error de sintaxis de código, cuenta/producto erróneo…)

**Procedimiento de Rollback:** En caso de error y modificación de base de datos, recuperar el backup de MongoDB.

## 5. Comunicación

**Partes Interesadas a Notificar:** Notificar a de L1.

**Método de Comunicación:** Aplicación JIRA (comentarios)

## 6. Apéndice

**Referencias:** N/A

## 7. Historial de Revisiones

| Versión | Fecha       | Autor            | Descripción de los Cambios                      |
|---------|-------------|------------------|-----------------------------------------------|
| 1.0     | 01/04/2025  | Víctor Márquez   | Creación del documento                        |
| 1.1     | 02/04/2025  | Samuel Carretero | Revisión y modificación de la descripción de algunos de los campos |
| 1.2     | 10/04/2025  | Víctor Márquez   | Adaptar a nueva plantilla y añadir enlaces directos. |