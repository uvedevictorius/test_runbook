# **Runbook - Procedimiento Añadir Cuenta a Producto Poseidón**



### **Introducción**
Este Runbook proporciona instrucciones paso a paso para llevar a cabo una tarea operativa específica dentro del Servicio de Plataforma de Ingeniería. El objetivo es añadir una cuenta que se creó por fuera de Poseidón a un producto. 



### **Información del Documento**
- **Título del Runbook:** Procedimiento Añadir Cuenta a Producto Poseidón  
- **Versión:** 1.3 
- **Fecha de Creación:** 31/03/2025  
- **Fecha de Última Modificación:** 09/04/2025  
- **Autor:** Víctor Márquez Gómez   
- **Revisor:** Samuel Carretero Jara  
- **Aprobador:** Rubén Barrero Ortega 



### **1. Información General**
- **Descripción de la Tarea:** Añadir cuenta a producto, cuenta creada por fuera de Poseidón, conectando manualmente la base de datos.  
- **Servicio/Sistema Afectado:** MongoDB (AWS) y portal Plataforma Ingeniería.  
- **Duración Estimada:** 20 minutos aproximadamente.  
- **Ventana de Mantenimiento:** N/A.  
- **Riesgos:** El entorno donde se desarrolla la actividad es producción.  
- **Requisitos Previos:** Tener acceso a las cuentas de AWS de Poseidón, acceso para conectarse a la base de datos (Cloud9), nombre y número de cuenta y nombre de producto al que se quiere asociar. 
 


### **2. Procedimiento Detallado**
**Paso 1:** Conectarse a la base de datos de Poseidón MongoDB (Leer pasos a continuación).
**Paso 1.1:** Acceder a la cuenta aws-pro-poseidon-mapfretech (847912841198) de AWS de Poseidón haciendo click en owner.  [Accounts | AWS access portal]  (https://mapfreaws.awsapps.com/start/#/?tab=accounts.)

![Texto alternativo](https://i.postimg.cc/vmXLbMDK/001.png)

**Paso 1.2:** Acceder al servicio Cloud9 a través de AWS.

![Texto alternativo](https://i.postimg.cc/fk4YBRgV/002.png)

**Paso 1.3:** Establecer conexión con MongoDB a través del entorno `fparisowner` seleccionando el apartado de “Shared with me” y luego “Open in Cloud9”.

![Texto alternativo](https://i.postimg.cc/0jKpYwZg/003.png)

**Paso 1.4:** Utilizar comando con contraseña y escribir `use poseidon` en una nueva terminal para establecer conexión con la base de datos de Poseidón.  

![Texto alternativo](https://i.postimg.cc/tTM3n53t/004.png)

**Paso 2:** Buscar la lista de autorizadores de la entidad en la base de datos de Poseidón utilizando el siguiente comando y buscando la colección `"entity_authorizers"`:

``db.entity.find({"entity_name":"XXX"}).pretty()``

**Paso 2.1:** Crear backup de la base de datos con el siguiente comando: (Se necesita contraseña) 

``mongoexport --ssl --host 'psdn-source-psdn-metadata.cluster-ctrly2qeqwpv.eu-west-1.docdb.amazonaws.com:27017' --sslCAFile global-bundle.pem --username 'admin1' --password 'XXXX' --db 'poseidon' --ssl --collection='XXXX' --out=XXXX_YearMonthDayHourMinutes.json``

**Paso 3:** Editar la lista de autorizadores ("entity_authorizers") utilizando el siguiente comando:

``db.entity.updateOne({"entity_name": “XXX"}, {$set:{"entity_authorizers" : [{"authorizer_email" : "XXX", "authorizer_display_name" : "XXX", "authorizer_upn" : "XXX"}, {"authorizer_email" : "XXX, "authorizer_display_name" : "XXX", "authorizer_upn" : "XXX"}]}}) ``

### **3. Verificación y Validación**

**Criterios de Éxito**
- Mensaje de confirmación en Mondo DB

``{ "acknowledged" : true, "matchedCount" : 1, "modifiedCount" : 1 }``

**Procedimiento de Verificación**

* Acudir al paso 2 para buscar la lista de autorizadores de la entidad.

**Procedimiento de Validación**

* Ver la lista de autorizadores disponibles al modificar en la plataforma de ingeniería.

### **4. Manejo de Excepciones y Rollback**

**Posibles Errores**

* Errores humanos:
    * Error de sintaxis de código.
    * Cuenta/producto erróneo.

**Acciones Correctivas**

* Restaurar el backup en caso de modificar erróneamente la base de datos.

**Procedimiento de Rollback**

* En caso de error y modificación de la base de datos, recuperar el backup de MongoDB.

### **5. Comunicación**

**Partes Interesadas a Notificar**

* Notificar a compañeros de L1 que se procede a la modificación de la base de datos.

**Método de Comunicación**

* Aplicación JIRA, comunicación con L1.

**Plantilla de Notificación**

* N/A

### **6. Apéndice**

**Referencias**

* N/A

**Información de Contacto**

* Equipo Técnico

### **7. Historial de Revisiones**

| Versión | Fecha        | Autor                   | Descripción de los Cambios                                                                       |
|---------|--------------|-------------------------|-------------------------------------------------------------------------------------------------|
| 1.0     | 01/04/2025   | Víctor Márquez Gómez    | Creación del documento.                                                                        |
| 1.1     | 02/04/2025   | Samuel Carretero Jara   | Revisión y modificación de la descripción de algunos campos y adición de capturas de pantalla. |